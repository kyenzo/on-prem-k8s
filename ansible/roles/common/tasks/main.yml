---
# Common system preparation tasks for all nodes

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [common, packages]

- name: Install common packages
  apt:
    name: "{{ common_packages }}"
    state: present
  tags: [common, packages]

- name: Disable swap
  shell: |
    swapoff -a
    sed -i '/swap/d' /etc/fstab
  when: disable_swap | bool
  tags: [common, swap]

- name: Check if swap is disabled
  command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false
  tags: [common, swap]

- name: Load kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ kernel_modules }}"
  tags: [common, kernel]

- name: Persist kernel modules
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      {% for module in kernel_modules %}
      {{ module }}
      {% endfor %}
  tags: [common, kernel]

- name: Set sysctl parameters
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: yes
    reload: yes
  loop: "{{ sysctl_params | dict2items }}"
  tags: [common, sysctl]

- name: Persist sysctl parameters
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      {% for key, value in sysctl_params.items() %}
      {{ key }} = {{ value }}
      {% endfor %}
  tags: [common, sysctl]

- name: Ensure required directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/apt/keyrings
    - /opt/cni/bin
  tags: [common, directories]

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"
  tags: [common, hostname]
