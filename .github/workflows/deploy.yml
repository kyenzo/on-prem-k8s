name: Deploy to EC2

on:
  push:
    branches:
      - master

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  deploy:
    name: Deploy to Ubuntu EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ca-west-1

      - name: Get EC2 SSH Private Key from AWS Secrets Manager
        id: get-ssh-key
        run: |
          echo "ðŸ” Retrieving SSH private key from AWS Secrets Manager..."

          SSH_KEY=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-ssh-private-key" \
            --query 'SecretString' \
            --output text)

          if [ -z "$SSH_KEY" ]; then
            echo "âŒ SSH key secret not found or empty"
            exit 1
          fi

          # Verify it's a valid PEM format
          if echo "$SSH_KEY" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âœ… SSH private key retrieved successfully"
          else
            echo "âŒ SSH key doesn't appear to be valid PEM format"
            exit 1
          fi

          # Save to file with proper permissions
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Get EC2 Host IP from AWS Secrets Manager
        id: get-ec2-ip
        run: |
          echo "ðŸ” Retrieving EC2 host IP from AWS Secrets Manager..."

          EC2_IP=$(aws secretsmanager get-secret-value \
            --secret-id "k8s-vms/ec2-public-ip" \
            --query 'SecretString' \
            --output text)

          if [ -z "$EC2_IP" ]; then
            echo "âŒ EC2 IP secret not found or empty"
            exit 1
          fi

          echo "âœ… EC2 IP retrieved: $EC2_IP"
          echo "EC2_HOST=$EC2_IP" >> $GITHUB_OUTPUT

      - name: Configure SSH
        env:
          EC2_HOST: ${{ steps.get-ec2-ip.outputs.EC2_HOST }}
        run: |
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          echo "âœ… SSH configured for $EC2_HOST"

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ steps.get-ec2-ip.outputs.EC2_HOST }}
          EC2_USER: ubuntu
          DEPLOY_PATH: /home/ubuntu/on-prem-k8s
        run: |
          echo "=========================================="
          echo "ðŸš€ Deploying on-prem-k8s to EC2"
          echo "=========================================="
          echo "Target: $EC2_USER@$EC2_HOST"
          echo "Path: $DEPLOY_PATH"
          echo ""

          ssh -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e

            echo "ðŸ“¦ Navigating to deployment directory..."

            # Create directory if it doesn't exist
            mkdir -p ${DEPLOY_PATH}
            cd ${DEPLOY_PATH}

            # Check if repository exists
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Repository exists. Pulling latest changes..."
              git fetch origin
              git reset --hard origin/master
              git clean -fd
            else
              echo "ðŸ“¦ Repository doesn't exist. Cloning..."
              cd $(dirname ${DEPLOY_PATH})
              git clone https://github.com/${{ github.repository }}.git $(basename ${DEPLOY_PATH})
              cd $(basename ${DEPLOY_PATH})
            fi

            echo ""
            echo "=========================================="
            echo "âœ… Current commit:"
            git log -1 --oneline
            echo "=========================================="
            echo ""
            echo "ðŸŽ‰ Deployment successful!"
            echo ""
            echo "Next steps:"
            echo "  cd ${DEPLOY_PATH}"
            echo "  vagrant up --provider=libvirt"
            echo "  ./setup-cluster.sh"
          EOF

      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa

          